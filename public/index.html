<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description" content="Rol semanal litúrgico del Templo San Miguel Arcángel. Ofrece tu servicio como lector, monitor o colector.">
<meta name="theme-color" content="#0b2a4a" id="metaTheme">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⛪</text></svg>">
<title>ROL SEMANAL LITÚRGICO</title>

<style>
/* ===== Reset ===== */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}

/* ===== Tokens: Light Mode ===== */
:root{
  --primary:#1a5276;
  --primary-hover:#1f6999;
  --primary-soft:rgba(26,82,118,.08);

  --bg:#f4f6f9;
  --surface:#ffffff;
  --surface-hover:#f8fafc;
  --text:#1e293b;
  --text-secondary:#475569;
  --text-muted:#94a3b8;

  --border:#e2e8f0;
  --border-focus:#1a5276;
  --focus-ring:rgba(26,82,118,.18);

  --success:#16a34a;
  --success-bg:#dcfce7;
  --success-border:#86efac;
  --danger:#dc2626;
  --danger-bg:#fef2f2;
  --danger-border:#fca5a5;

  --radius:10px;
  --radius-lg:14px;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.04);
  --shadow-lg:0 4px 24px rgba(0,0,0,.08);

  --header-bg:linear-gradient(135deg,#0f3d5c 0%,#1a5276 50%,#1f6999 100%);
  --header-text:#ffffff;

  --table-header-bg:#f1f5f9;
  --table-stripe:rgba(0,0,0,.015);
  --table-hover:rgba(26,82,118,.04);

  --transition:200ms ease;
  color-scheme:light dark;
}

/* ===== Tokens: Dark Mode ===== */
[data-theme="dark"]{
  --primary:#5ba3d9;
  --primary-hover:#7db8e3;
  --primary-soft:rgba(91,163,217,.1);

  --bg:#0f172a;
  --surface:#1e293b;
  --surface-hover:#273548;
  --text:#e2e8f0;
  --text-secondary:#94a3b8;
  --text-muted:#64748b;

  --border:#334155;
  --border-focus:#5ba3d9;
  --focus-ring:rgba(91,163,217,.25);

  --success:#4ade80;
  --success-bg:rgba(74,222,128,.1);
  --success-border:rgba(74,222,128,.3);
  --danger:#f87171;
  --danger-bg:rgba(248,113,113,.1);
  --danger-border:rgba(248,113,113,.3);

  --shadow:0 1px 3px rgba(0,0,0,.2),0 4px 16px rgba(0,0,0,.15);
  --shadow-lg:0 4px 24px rgba(0,0,0,.25);

  --header-bg:linear-gradient(135deg,#0c1829 0%,#152238 50%,#1a3050 100%);
  --header-text:#e2e8f0;

  --table-header-bg:#1a2744;
  --table-stripe:rgba(255,255,255,.02);
  --table-hover:rgba(91,163,217,.06);
}

/* ===== Base ===== */
body{
  font-family:-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  line-height:1.6;
  min-height:100vh;
  transition:background var(--transition),color var(--transition);
  -webkit-font-smoothing:antialiased;
}

/* ===== Header ===== */
header{
  background:var(--header-bg);
  color:var(--header-text);
  padding:28px 0;
  position:relative;
}
header .wrap{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
}
.header-content{flex:1;}
h1{
  font-size:clamp(17px,3.2vw,24px);
  font-weight:800;
  letter-spacing:.3px;
  line-height:1.3;
}
.sub{
  margin-top:8px;
  font-size:clamp(12px,2vw,14px);
  opacity:.8;
  line-height:1.7;
}

/* Theme Toggle */
.theme-toggle{
  background:rgba(255,255,255,.15);
  border:1px solid rgba(255,255,255,.2);
  border-radius:50%;
  width:40px;height:40px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  transition:background var(--transition);
  flex-shrink:0;
  margin-top:2px;
  font-size:18px;
  line-height:1;
}
.theme-toggle:hover{background:rgba(255,255,255,.25);}
.theme-toggle .icon-dark{display:inline;}
.theme-toggle .icon-light{display:none;}
[data-theme="dark"] .theme-toggle .icon-dark{display:none;}
[data-theme="dark"] .theme-toggle .icon-light{display:inline;}

/* ===== Layout ===== */
.wrap{max-width:1280px;margin:0 auto;padding:0 20px;}
main.wrap{
  padding-top:24px;
  padding-bottom:40px;
  display:flex;
  flex-direction:column;
  gap:24px;
}

/* ===== Card ===== */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:24px;
  box-shadow:var(--shadow);
  transition:background var(--transition),border-color var(--transition);
}
.card-title{
  font-size:15px;
  font-weight:700;
  color:var(--text);
  margin-bottom:18px;
  display:flex;
  align-items:center;
  gap:8px;
}
.card-title span{font-size:18px;}

/* ===== Form ===== */
.form-grid{
  display:grid;
  grid-template-columns:1.4fr 1fr 0.8fr 1.1fr;
  gap:16px;
  align-items:end;
}
.form-group{display:flex;flex-direction:column;gap:6px;}
.form-group label{
  font-size:12px;
  font-weight:700;
  color:var(--text-secondary);
  text-transform:uppercase;
  letter-spacing:.6px;
}
input,select{
  width:100%;
  padding:11px 14px;
  border:1.5px solid var(--border);
  border-radius:var(--radius);
  font-size:15px;
  font-family:inherit;
  color:var(--text);
  background:var(--surface);
  transition:border-color var(--transition),box-shadow var(--transition),background var(--transition);
  appearance:none;
  -webkit-appearance:none;
}
select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px center;
  padding-right:36px;
}
input::placeholder{color:var(--text-muted);}
input:focus,select:focus{
  outline:none;
  border-color:var(--border-focus);
  box-shadow:0 0 0 3px var(--focus-ring);
}

/* ===== Buttons ===== */
.btn-row{
  display:flex;
  gap:10px;
  align-self:end;
}
button{
  padding:11px 20px;
  border-radius:var(--radius);
  border:none;
  font-weight:700;
  font-size:14px;
  font-family:inherit;
  cursor:pointer;
  white-space:nowrap;
  transition:background var(--transition),transform 100ms ease,opacity var(--transition),box-shadow var(--transition);
}
button:active:not(:disabled){transform:scale(.97);}
button:disabled{opacity:.5;cursor:not-allowed;transform:none;}
button:focus-visible{outline:2px solid var(--border-focus);outline-offset:2px;}

.btn-primary{
  background:var(--primary);
  color:#fff;
  box-shadow:0 1px 3px rgba(0,0,0,.15);
}
.btn-primary:hover:not(:disabled){background:var(--primary-hover);box-shadow:0 2px 8px rgba(0,0,0,.2);}

.btn-danger{
  background:var(--danger-bg);
  color:var(--danger);
  border:1px solid var(--danger-border);
}
.btn-danger:hover:not(:disabled){opacity:.85;}

/* ===== Toast ===== */
.toast{
  margin-top:14px;
  padding:12px 16px;
  border-radius:var(--radius);
  font-size:14px;
  font-weight:600;
  display:none;
  animation:toastIn .35s ease;
  border:1px solid transparent;
}
.toast.show{display:flex;align-items:center;gap:8px;}
.toast .toast-icon{font-size:16px;flex-shrink:0;}
.toast.success{background:var(--success-bg);color:var(--success);border-color:var(--success-border);}
.toast.error{background:var(--danger-bg);color:var(--danger);border-color:var(--danger-border);}

@keyframes toastIn{
  from{opacity:0;transform:translateY(-8px);}
  to{opacity:1;transform:translateY(0);}
}

/* ===== Loader ===== */
.loader{
  display:none;
  text-align:center;
  padding:48px 20px;
  color:var(--text-muted);
  font-size:14px;
}
.loader.show{display:block;}
.loader .spinner{
  width:36px;height:36px;
  border:3px solid var(--border);
  border-top-color:var(--primary);
  border-radius:50%;
  animation:spin .7s linear infinite;
  margin:0 auto 14px;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* ===== Scroll hint (mobile) ===== */
.table-container{position:relative;}
.scroll-hint{
  display:none;
  text-align:center;
  padding:8px;
  font-size:12px;
  color:var(--text-muted);
  gap:6px;
  align-items:center;
  justify-content:center;
}
.scroll-hint svg{width:16px;height:16px;fill:var(--text-muted);}

/* ===== Table ===== */
.table-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  border-radius:var(--radius-lg);
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  transition:border-color var(--transition);
}
table{
  width:100%;
  min-width:960px;
  border-collapse:collapse;
  background:var(--surface);
  table-layout:fixed;
  transition:background var(--transition);
}
th,td{
  padding:13px 12px;
  border-bottom:1px solid var(--border);
  vertical-align:middle;
  word-break:break-word;
  transition:background var(--transition),border-color var(--transition);
}
th{
  background:var(--table-header-bg);
  font-size:11px;
  font-weight:700;
  color:var(--text-secondary);
  text-transform:uppercase;
  letter-spacing:.6px;
  text-align:center;
  position:sticky;
  top:0;
  z-index:2;
}
tr:last-child td{border-bottom:none;}
tbody tr:nth-child(even) td{background:var(--table-stripe);}
tbody tr:hover td{background:var(--table-hover);}

td.meta{
  white-space:nowrap;
  text-align:center;
  font-weight:700;
  color:var(--primary);
  font-size:14px;
}
td.cell{text-align:center;font-size:14px;}
.empty{color:var(--text-muted);font-style:italic;font-size:13px;}
.name{
  font-weight:700;
  color:var(--text);
  display:inline-block;
  padding:3px 10px;
  background:var(--primary-soft);
  border-radius:6px;
  font-size:13px;
}

/* ===== Footer ===== */
.site-footer{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:28px 24px;
  text-align:center;
  box-shadow:var(--shadow);
  transition:background var(--transition),border-color var(--transition);
}
.site-footer .footer-title{
  color:var(--primary);
  font-size:17px;
  font-weight:800;
}
.site-footer em{
  display:block;
  margin-top:8px;
  color:var(--primary);
  font-size:15px;
  opacity:.8;
}
.site-footer p{
  font-size:14px;
  color:var(--text-secondary);
  max-width:640px;
  margin:14px auto 0;
  line-height:1.7;
}

/* ===== Responsive: Tablet ===== */
@media(max-width:900px){
  .form-grid{
    grid-template-columns:1fr 1fr;
  }
  .scroll-hint{display:flex;}
}

/* ===== Responsive: Mobile ===== */
@media(max-width:600px){
  .wrap{padding:0 14px;}
  header{padding:20px 0;}
  header .wrap{flex-direction:row;}
  .theme-toggle{width:36px;height:36px;font-size:16px;}
  main.wrap{padding-top:16px;padding-bottom:28px;gap:16px;}

  .card{padding:18px 16px;}
  .card-title{font-size:14px;margin-bottom:14px;}
  .form-grid{grid-template-columns:1fr;gap:12px;}
  .btn-row{flex-direction:column;}
  .btn-row button{width:100%;padding:13px;font-size:15px;}

  .site-footer{padding:22px 16px;}
  .site-footer .footer-title{font-size:15px;}
  .site-footer em{font-size:14px;}
  .site-footer p{font-size:13px;}
}

@media(max-width:380px){
  .wrap{padding:0 10px;}
  h1{font-size:14px;}
  .sub{font-size:11px;}
}
</style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="header-content">
      <h1>TEMPLO SAN MIGUEL ARCÁNGEL — ROL SEMANAL LITÚRGICO</h1>
      <div class="sub">
        Responsables: Sr. Cura Jorge Hernández Contreras y Padre Abel Salgado Anzures<br>
        «Como comunidad litúrgica, servimos con un solo corazón»
      </div>
    </div>
    <button class="theme-toggle" id="themeToggle" type="button" aria-label="Cambiar tema claro/oscuro" title="Cambiar tema">
      <span class="icon-dark">&#127769;</span>
      <span class="icon-light">&#9728;&#65039;</span>
    </button>
  </div>
</header>

<main class="wrap">

  <section class="card" aria-label="Formulario de servicio">
    <div class="card-title"><span>&#9997;&#65039;</span> Ofrece tu servicio</div>
    <div class="form-grid">
      <div class="form-group">
        <label for="nombre">Tu nombre</label>
        <input id="nombre" type="text" placeholder="Ej. María López" autocomplete="name" maxlength="100">
      </div>
      <div class="form-group">
        <label for="dia">Día</label>
        <select id="dia"></select>
      </div>
      <div class="form-group">
        <label for="misa">Misa</label>
        <select id="misa"></select>
      </div>
      <div class="form-group">
        <label for="servicio">Servicio</label>
        <select id="servicio"></select>
      </div>
    </div>
    <div style="margin-top:18px;">
      <div class="btn-row">
        <button class="btn-primary" id="btnAssign" type="button">Ofrecer mi servicio</button>
        <button class="btn-danger" id="btnClear" type="button">Limpiar tabla</button>
      </div>
    </div>
    <div id="toast" class="toast" role="alert" aria-live="polite">
      <span class="toast-icon"></span>
      <span class="toast-msg"></span>
    </div>
  </section>

  <div class="loader" id="loader">
    <div class="spinner"></div>
    Cargando asignaciones...
  </div>

  <section class="table-container" aria-label="Tabla de asignaciones">
    <div class="scroll-hint" id="scrollHint">
      <svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
      Desliza para ver toda la tabla
    </div>
    <div class="table-wrap">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <footer class="site-footer">
    <div class="footer-title">Gracias, servidor litúrgico.</div>
    <em>«Un día contigo es un ayer que pasó»</em>
    <p>
      Esta frase nos recuerda que el tiempo ofrecido a Jesús se transforma en eternidad.
      Servir hoy deja huella y permanece en el corazón de Dios.
    </p>
  </footer>

</main>

<script>
(() => {
  'use strict';

  /* ===== Configuración ===== */
  const API = '/api';
  const SERVICIOS = ['Monitor', 'Lectura 1', 'Salmo', 'Lectura 2', 'Rifa', 'Colecta / Hojita'];
  const DIAS = [
    { dia: 'Lunes',     misas: ['7:00', 'Extra'] },
    { dia: 'Martes',    misas: ['7:00', '19:00', 'Extra'] },
    { dia: 'Miércoles', misas: ['7:00', '19:00', 'Extra'] },
    { dia: 'Jueves',    misas: ['7:00', '19:00', 'Extra'] },
    { dia: 'Viernes',   misas: ['7:00', '18:00', 'Extra'] },
    { dia: 'Sábado',    misas: ['7:00', '18:00', 'Extra'] },
    { dia: 'Domingo',   misas: ['7:00', '12:00', '19:00', 'Extra'] },
  ];
  const REFRESH_MS = 10000;

  /* ===== DOM ===== */
  const $ = id => document.getElementById(id);
  const nombre    = $('nombre');
  const diaEl     = $('dia');
  const misaEl    = $('misa');
  const servEl    = $('servicio');
  const btnAssign = $('btnAssign');
  const btnClear  = $('btnClear');
  const toastEl   = $('toast');
  const loader    = $('loader');
  const thead     = $('thead');
  const tbody     = $('tbody');

  /* ===== Theme Toggle ===== */
  const themeToggle = $('themeToggle');
  const metaTheme   = $('metaTheme');

  function getPreferredTheme() {
    const stored = localStorage.getItem('theme');
    if (stored) return stored;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    metaTheme.content = theme === 'dark' ? '#0f172a' : '#0f3d5c';
    localStorage.setItem('theme', theme);
  }

  applyTheme(getPreferredTheme());

  themeToggle.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    applyTheme(current === 'dark' ? 'light' : 'dark');
  });

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    if (!localStorage.getItem('theme')) {
      applyTheme(e.matches ? 'dark' : 'light');
    }
  });

  /* ===== Helpers ===== */
  function fillSelect(el, items) {
    el.innerHTML = items.map(v => `<option value="${v}">${v}</option>`).join('');
  }

  function showToast(msg, type = 'success') {
    const icon = type === 'success' ? '\u2705' : '\u26A0\uFE0F';
    toastEl.querySelector('.toast-icon').textContent = icon;
    toastEl.querySelector('.toast-msg').textContent = msg;
    toastEl.className = `toast show ${type}`;
    clearTimeout(toastEl._timer);
    toastEl._timer = setTimeout(() => { toastEl.className = 'toast'; }, 5000);
  }

  function setLoading(on) {
    loader.className = on ? 'loader show' : 'loader';
  }

  function setButtonBusy(btn, busy) {
    btn.disabled = busy;
    if (busy) {
      btn._text = btn.textContent;
      btn.textContent = 'Procesando\u2026';
    } else {
      btn.textContent = btn._text || btn.textContent;
    }
  }

  async function api(method, endpoint, body) {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(`${API}${endpoint}`, opts);
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Error del servidor');
    return data;
  }

  function escapeHtml(str) {
    const el = document.createElement('span');
    el.textContent = str;
    return el.innerHTML;
  }

  /* ===== Poblar selects ===== */
  fillSelect(diaEl, DIAS.map(d => d.dia));
  fillSelect(servEl, SERVICIOS);

  diaEl.addEventListener('change', () => {
    const d = DIAS.find(x => x.dia === diaEl.value);
    if (d) fillSelect(misaEl, d.misas);
  });
  diaEl.dispatchEvent(new Event('change'));

  /* ===== Dibujar tabla ===== */
  async function draw() {
    try {
      const rows = await api('GET', '/asignaciones');

      thead.innerHTML = `<tr><th>Día</th><th>Hora</th>${SERVICIOS.map(s => `<th>${s}</th>`).join('')}</tr>`;

      const fragment = document.createDocumentFragment();

      DIAS.forEach(d => {
        d.misas.forEach((m, i) => {
          const tr = document.createElement('tr');
          let html = '';

          if (i === 0) {
            html += `<td class="meta" rowspan="${d.misas.length}">${d.dia}</td>`;
          }
          html += `<td class="meta">${m}</td>`;

          SERVICIOS.forEach(s => {
            const found = rows.find(r => r.dia === d.dia && r.hora === m && r.servicio === s);
            const val = found ? found.nombre : '';
            html += `<td class="cell">${
              val ? `<span class="name">${escapeHtml(val)}</span>` : '<span class="empty">\u2014 disponible \u2014</span>'
            }</td>`;
          });

          tr.innerHTML = html;
          fragment.appendChild(tr);
        });
      });

      tbody.innerHTML = '';
      tbody.appendChild(fragment);
    } catch (err) {
      showToast('No se pudieron cargar las asignaciones. Reintentando\u2026', 'error');
    }
  }

  /* ===== Ofrecer servicio ===== */
  btnAssign.addEventListener('click', async () => {
    const n = nombre.value.trim();
    if (!n) {
      showToast('Escribe tu nombre para continuar.', 'error');
      nombre.focus();
      return;
    }

    setButtonBusy(btnAssign, true);
    try {
      await api('POST', '/asignar', {
        dia: diaEl.value,
        hora: misaEl.value,
        servicio: servEl.value,
        nombre: n,
      });
      nombre.value = '';
      showToast('Gracias por ofrecer tu servicio. \u00A1Dios te bendiga!');
      await draw();
    } catch (err) {
      showToast(err.message || 'No se pudo guardar. Intenta otra vez.', 'error');
    } finally {
      setButtonBusy(btnAssign, false);
    }
  });

  /* ===== Limpiar tabla ===== */
  btnClear.addEventListener('click', async () => {
    const pin = prompt('Ingresa el NIP de administrador:');
    if (!pin) return;

    if (!confirm('\u00bfEst\u00e1s seguro de que deseas limpiar toda la tabla? Esta acci\u00f3n no se puede deshacer.')) {
      return;
    }

    setButtonBusy(btnClear, true);
    try {
      await api('POST', '/limpiar', { pin });
      showToast('Tabla limpia correctamente.');
      await draw();
    } catch (err) {
      showToast(err.message || 'No se pudo limpiar la tabla.', 'error');
    } finally {
      setButtonBusy(btnClear, false);
    }
  });

  /* ===== Auto-refresh inteligente ===== */
  let refreshTimer = null;

  function startRefresh() {
    stopRefresh();
    refreshTimer = setInterval(draw, REFRESH_MS);
  }

  function stopRefresh() {
    if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      stopRefresh();
    } else {
      draw();
      startRefresh();
    }
  });

  /* ===== Inicio ===== */
  setLoading(true);
  draw().finally(() => {
    setLoading(false);
    startRefresh();
  });

})();
</script>

</body>
</html>
